{
  "variables": {
    "proxmox_url": "{{env `PROXMOX_URL`}}",
    "proxmox_username": "{{env `PROXMOX_USERNAME`}}",
    "proxmox_password": "{{env `PROXMOX_PASSWORD`}}",
    "proxmox_node": "{{env `PROXMOX_NODE`}}",
    "vm_id": "9002",
    "vm_name": "windows-server-2022-template",
    "template_description": "Windows Server 2022 template created with Packer",
    "iso_file": "local:iso/windows-server-2022.iso",
    "virtio_iso": "local:iso/virtio-win.iso",
    "storage_pool": "local-zfs",
    "disk_size": "60G",
    "memory": "4096",
    "cores": "2",
    "winrm_username": "Administrator",
    "winrm_password": "P@ssw0rd123!"
  },
  "builders": [
    {
      "type": "proxmox",
      "proxmox_url": "{{user `proxmox_url`}}",
      "username": "{{user `proxmox_username`}}",
      "password": "{{user `proxmox_password`}}",
      "node": "{{user `proxmox_node`}}",
      "insecure_skip_tls_verify": true,
      
      "vm_id": "{{user `vm_id`}}",
      "vm_name": "{{user `vm_name`}}",
      "template_description": "{{user `template_description`}}",
      
      "iso_file": "{{user `iso_file`}}",
      "iso_storage_pool": "local",
      "unmount_iso": true,
      
      "additional_iso_files": [
        {
          "device": "ide3",
          "iso_file": "{{user `virtio_iso`}}",
          "unmount": true
        }
      ],
      
      "memory": "{{user `memory`}}",
      "cores": "{{user `cores`}}",
      "sockets": "1",
      "os": "win10",
      "cpu_type": "host",
      "machine": "q35",
      
      "scsi_controller": "virtio-scsi-pci",
      "disks": [
        {
          "type": "virtio",
          "disk_size": "{{user `disk_size`}}",
          "storage_pool": "{{user `storage_pool`}}",
          "storage_pool_type": "zfspool",
          "format": "raw"
        }
      ],
      
      "network_adapters": [
        {
          "model": "virtio",
          "bridge": "vmbr0"
        }
      ],
      
      "cloud_init": false,
      
      "floppy_files": [
        "./Autounattend.xml",
        "./setup.ps1"
      ],
      
      "boot_wait": "3m",
      
      "communicator": "winrm",
      "winrm_username": "{{user `winrm_username`}}",
      "winrm_password": "{{user `winrm_password`}}",
      "winrm_timeout": "30m",
      "winrm_use_ssl": false,
      "winrm_insecure": true,
      
      "qemu_agent": false
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "inline": [
        "# Install Windows Updates",
        "Install-PackageProvider -Name NuGet -Force",
        "Install-Module PSWindowsUpdate -Force",
        "Get-WindowsUpdate -AcceptAll -Install -AutoReboot"
      ]
    },
    {
      "type": "windows-restart",
      "restart_timeout": "15m"
    },
    {
      "type": "powershell",
      "inline": [
        "# Install RSAT tools",
        "Get-WindowsCapability -Name RSAT* -Online | Add-WindowsCapability -Online",
        "# Enable Remote Desktop",
        "Set-ItemProperty -Path 'HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server' -name 'fDenyTSConnections' -Value 0",
        "Enable-NetFirewallRule -DisplayGroup 'Remote Desktop'"
      ]
    },
    {
      "type": "powershell",
      "script": "../../scripts/windows-cleanup.ps1"
    }
  ]
}